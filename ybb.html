<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:sans-serif;background:#f0f2f5;padding:15px;color:#333}
    .container{max-width:900px;margin:0 auto;background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center}
    .content{padding:20px}
    .section{margin-bottom:30px}
    .section-title{font-size:18px;color:#667eea;font-weight:bold;margin-bottom:12px;border-bottom:2px solid #eee;padding-bottom:5px}
    table{width:100%;border-collapse:collapse;margin-bottom:10px;table-layout:fixed}
    th,td{border:1px solid #e0e0e0;padding:10px;text-align:center;font-size:14px}
    th{background:#f8f9fa;color:#666}
    .row-label{background:#fafafa;font-weight:bold;text-align:left;width:100px}
    input{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:15px;outline:none}
    /* æ ¸å¿ƒï¼šå˜åŠ¨çº¢å­—æ ·å¼ */
    input.is-changed { color: red !important; font-weight: bold; border: 1px solid red !important; background: #fff5f5; }
    textarea{width:100%;height:100px;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;outline:none;resize:none}
    .footer-btn{background:white;padding:20px;text-align:center;border-top:1px solid #eee}
    .btn-export{width:100%;max-width:400px;padding:15px;background:#28a745;color:white;border:none;border-radius:30px;font-size:18px;font-weight:bold;cursor:pointer}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ—ï¸ å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥</h1>
        <div id="dateDisplay" style="margin-top:10px;opacity:0.9"></div>
    </div>

    <div class="content">
        <div class="section">
            <div class="section-title">1ï¸âƒ£ æ¥¼æ¢¯é—´è¿›åº¦ (ST01 - ST06)</div>
            <table>
                <thead><tr><th>ä½ç½®</th><th>è„šæ‰‹æ¶</th><th>é’¢ç­‹</th><th>æ¨¡æ¿</th><th>æ··å‡åœŸ</th></tr></thead>
                <tbody id="st_tbody">
                    </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">2ï¸âƒ£ ç”µæ¢¯äº•è¿›åº¦ (LF)</div>
            <table>
                <thead><tr><th>ä½ç½®</th><th>è„šæ‰‹æ¶</th><th>é’¢ç­‹</th><th>æ¨¡æ¿</th><th>æ··å‡åœŸ</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">LF01/02</td>
                        <td><input type="number" data-key="lf0102_sc"></td><td><input type="number" data-key="lf0102_re"></td>
                        <td><input type="number" data-key="lf0102_fo"></td><td><input type="number" data-key="lf0102_co"></td></tr>
                    <tr><td class="row-label">LF03</td>
                        <td><input type="number" data-key="lf03_sc"></td><td><input type="number" data-key="lf03_re"></td>
                        <td><input type="number" data-key="lf03_fo"></td><td><input type="number" data-key="lf03_co"></td></tr>
                    <tr><td class="row-label">GLF01/02</td>
                        <td><input type="number" data-key="glf0102_sc"></td><td><input type="number" data-key="glf0102_re"></td>
                        <td><input type="number" data-key="glf0102_fo"></td><td><input type="number" data-key="glf0102_co"></td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">3ï¸âƒ£ åŒºåŸŸè¿›åº¦ (Zone A-C)</div>
            <table>
                <thead><tr><th>åŒºåŸŸ</th><th>æ¢è¿›åº¦</th><th>æ¿è¿›åº¦</th><th>æŸ±è¿›åº¦</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">Zone A</td>
                        <td><input type="number" data-key="za_beam"></td><td><input type="number" data-key="za_slab"></td><td><input type="number" data-key="za_column"></td></tr>
                    <tr><td class="row-label">Zone B</td>
                        <td><input type="number" data-key="zb_beam"></td><td><input type="number" data-key="zb_slab"></td><td><input type="number" data-key="zb_column"></td></tr>
                    <tr><td class="row-label">Zone C</td>
                        <td><input type="number" data-key="zc_beam"></td><td><input type="number" data-key="zc_slab"></td><td><input type="number" data-key="zc_column"></td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">ğŸ“ ä»Šæ—¥å¤‡æ³¨ (å°†å¯¼å‡ºè‡³è¡¨æ ¼æœ«å°¾)</div>
            <textarea id="memo" data-key="ybb_memo" placeholder="åœ¨æ­¤è¾“å…¥ç‰¹æ®Šæƒ…å†µã€è¿›åº¦æ»åè¯´æ˜æˆ–æ˜æ—¥è®¡åˆ’..."></textarea>
        </div>
    </div>

    <div class="footer-btn">
        <button class="btn-export" onclick="submitAndExport()">âœ… æäº¤å¹¶å¯¼å‡ºæœ€ç»ˆæŠ¥è¡¨</button>
    </div>
</div>

<script>
    const storageKey = "ybb_data_final";
    const baseKey = "ybb_base_final";

    // åŠ¨æ€ç”Ÿæˆ ST01-06
    const stTbody = document.getElementById('st_tbody');
    for(let i=1; i<=6; i++){
        const id = 'st0' + i;
        stTbody.innerHTML += `
            <tr><td class="row-label">ST0${i}</td>
                <td><input type="number" data-key="${id}_sc"></td><td><input type="number" data-key="${id}_re"></td>
                <td><input type="number" data-key="${id}_fo"></td><td><input type="number" data-key="${id}_co"></td></tr>`;
    }

    // åˆå§‹åŒ–ï¼šåŠ è½½è‰ç¨¿ & æ¯”å¯¹åŸºå‡†
    window.onload = function() {
        document.getElementById('dateDisplay').innerText = "å¡«æŠ¥æ—¥æœŸï¼š" + new Date().toLocaleDateString();
        
        const base = JSON.parse(localStorage.getItem(baseKey) || '{}');
        const draft = JSON.parse(localStorage.getItem(storageKey) || '{}');

        document.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => {
            const k = el.dataset.key;
            el.value = draft[k] || ""; // æ¢å¤å¡«å†™çš„è‰ç¨¿

            // åªæœ‰æ•°å­—è¾“å…¥æ¡†è¿›è¡Œçº¢å­—æ¯”å¯¹
            if(el.tagName === 'INPUT' && el.value !== "" && el.value != (base[k] || "0")){
                el.classList.add('is-changed');
            }

            // å®æ—¶ä¿å­˜è‰ç¨¿å¹¶è§¦å‘å˜è‰²
            el.oninput = function() {
                const currentDraft = JSON.parse(localStorage.getItem(storageKey) || '{}');
                currentDraft[k] = this.value;
                localStorage.setItem(storageKey, JSON.stringify(currentDraft));

                if(this.tagName === 'INPUT'){
                    if(this.value != (base[k] || "0")){
                        this.classList.add('is-changed');
                    } else {
                        this.classList.remove('is-changed');
                    }
                }
            };
        });
    };

    function submitAndExport() {
        const currentData = {};
        let excelRows = "";
        const dateStr = new Date().toLocaleDateString();

        // 1. æŠ“å–æ‰€æœ‰è¡¨æ ¼æ•°æ®
        document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('.section-title')?.innerText;
            const table = sec.querySelector('table');
            
            if(table) {
                // æ·»åŠ ç« èŠ‚æ ‡é¢˜è¡Œ
                excelRows += `<tr style="background:#d9e1f2"><td colspan="2"><b>${title}</b></td></tr>`;
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.innerText);
                
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const rowName = tr.querySelector('.row-label').innerText;
                    excelRows += `<tr style="background:#f2f2f2"><td colspan="2"><b>${rowName}</b></td></tr>`;

                    tr.querySelectorAll('input').forEach((inp, idx) => {
                        const val = inp.value || "0";
                        currentData[inp.dataset.key] = val;
                        const isRed = inp.classList.contains('is-changed');
                        const style = isRed ? 'style="color:red;font-weight:bold"' : '';
                        excelRows += `<tr><td>ã€€${headers[idx+1]}</td><td ${style}>${val}</td></tr>`;
                    });
                });
            }
        });

        // 2. æŠ“å–å¤‡æ³¨å¹¶è¿½åŠ åˆ°æœ€å
        const memoVal = document.getElementById('memo').value;
        currentData['ybb_memo'] = memoVal;
        if(memoVal){
            excelRows += `<tr style="background:#fff2cc"><td><b>ä»Šæ—¥å¤‡æ³¨</b></td><td style="text-align:left">${memoVal}</td></tr>`;
        }

        // 3. å­˜ä¸ºæ–°çš„æ¯”å¯¹åŸºå‡†
        localStorage.setItem(baseKey, JSON.stringify(currentData));

        // 4. æ‰§è¡Œå¯¼å‡º
        const template = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
            <head><meta charset="utf-8"></head>
            <body>
                <table border="1">
                    <tr style="height:40px; background:#4472c4; color:white; font-size:18px">
                        <th colspan="2">å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥ (${dateStr})</th>
                    </tr>
                    ${excelRows}
                </table>
            </body>
            </html>`;

        const blob = new Blob([template], { type: 'application/vnd.ms-excel' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `å°¹å…µå…µ_æ—¥æŠ¥_${dateStr}.xls`;
        link.click();
        
        alert("å¤§å°¹å·¥å¹¸è‹¦äº†ï¼è®°å¾—æŠŠå¯¼å‡ºçš„æ–‡ä»¶å‘ç¾¤é‡Œã€‚");
    }
</script>
</body>
</html>