<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 15px; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
    .content { padding: 20px; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 18px; color: #667eea; font-weight: bold; margin-bottom: 12px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
    th, td { border: 1px solid #e0e0e0; padding: 10px; text-align: center; font-size: 14px; }
    th { background: #f8f9fa; color: #666; font-weight: bold; }
    .row-label { background: #fafafa; font-weight: bold; text-align: left; width: 100px; }
    input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 15px; outline: none; }
    input.is-changed { color: red !important; font-weight: bold; border: 1px solid red !important; background: #fff5f5; }
    textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; resize: none; }
    
    .footer-btn { background: #fafafa; padding: 20px; display: flex; flex-direction: column; gap: 12px; align-items: center; border-top: 1px solid #eee; }
    .btn-image { width: 100%; max-width: 400px; padding: 15px; background: #07c160; color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-export { width: 100%; max-width: 400px; padding: 12px; background: #667eea; color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-image:active, .btn-export:active { opacity: 0.7; transform: scale(0.98); }
    
    /* æ—¶é—´æˆ³æ°´å°æ ·å¼ - ä»…æˆªå›¾æ—¶æ˜¾ç¤º */
    #timestamp-watermark { display: none; text-align: right; padding: 10px 20px; color: #999; font-size: 12px; font-style: italic; background: white; }

    /* å›¾ç‰‡é¢„è§ˆæµ®å±‚ */
    #preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    #preview-image { max-width: 100%; max-height: 80%; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
</style>
</head>
<body>

<div id="capture-area" style="background: #f0f2f5; padding-bottom: 1px;">
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥</h1>
            <div id="dateDisplay" style="margin-top:10px;opacity:0.9"></div>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">1.æ¥¼æ¢¯é—´è¿›åº¦ (ST01 - ST06)</div>
                <table>
                    <thead><tr><th>ä½ç½®</th><th>è„šæ‰‹æ¶</th><th>é’¢ç­‹</th><th>æ¨¡æ¿</th><th>æ··å‡åœŸ</th></tr></thead>
                    <tbody id="st_tbody"></tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">2.ç”µæ¢¯äº•è¿›åº¦ (LF)</div>
                <table>
                    <thead><tr><th>ä½ç½®</th><th>è„šæ‰‹æ¶</th><th>é’¢ç­‹</th><th>æ¨¡æ¿</th><th>æ··å‡åœŸ</th></tr></thead>
                    <tbody>
                        <tr><td class="row-label">LF01/02</td><td><input type="number" data-key="lf0102_sc"></td><td><input type="number" data-key="lf0102_re"></td><td><input type="number" data-key="lf0102_fo"></td><td><input type="number" data-key="lf0102_co"></td></tr>
                        <tr><td class="row-label">LF03</td><td><input type="number" data-key="lf03_sc"></td><td><input type="number" data-key="lf03_re"></td><td><input type="number" data-key="lf03_fo"></td><td><input type="number" data-key="lf03_co"></td></tr>
                        <tr><td class="row-label">GLF01/02</td><td><input type="number" data-key="glf0102_sc"></td><td><input type="number" data-key="glf0102_re"></td><td><input type="number" data-key="glf0102_fo"></td><td><input type="number" data-key="glf0102_co"></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">3.1Fé¢„åˆ¶æ„ä»¶é¡¶éƒ¨æµ‡ç­‘è¿›åº¦</div>
                <table>
                    <thead><tr><th>åŒºåŸŸ</th><th>æ¢è¿›åº¦</th><th>æŸ±è¿›åº¦</th></tr></thead>
                    <tbody>
                        <tr><td class="row-label">Zone A</td><td><input type="number" data-key="f1_za_beam"></td><td><input type="number" data-key="f1_za_column"></td></tr>
                        <tr><td class="row-label">Zone B</td><td><input type="number" data-key="f1_zb_beam"></td><td><input type="number" data-key="f1_zb_column"></td></tr>
                        <tr><td class="row-label">Zone C</td><td><input type="number" data-key="f1_zc_beam"></td><td><input type="number" data-key="f1_zc_column"></td></tr>
                        <tr><td class="row-label">Zone D</td><td><input type="number" data-key="f1_zd_beam"></td><td><input type="number" data-key="f1_zd_column"></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">4.2Fé¢„åˆ¶æ„ä»¶é¡¶éƒ¨æµ‡ç­‘è¿›åº¦</div>
                <table>
                    <thead><tr><th>åŒºåŸŸ</th><th>æ¢è¿›åº¦</th><th>æŸ±è¿›åº¦</th></tr></thead>
                    <tbody>
                        <tr><td class="row-label">Zone A</td><td><input type="number" data-key="f2_za_beam"></td><td><input type="number" data-key="f2_za_column"></td></tr>
                        <tr><td class="row-label">Zone B</td><td><input type="number" data-key="f2_zb_beam"></td><td><input type="number" data-key="f2_zb_column"></td></tr>
                        <tr><td class="row-label">Zone C</td><td><input type="number" data-key="f2_zc_beam"></td><td><input type="number" data-key="f2_zc_column"></td></tr>
                        <tr><td class="row-label">Zone D</td><td><input type="number" data-key="f2_zd_beam"></td><td><input type="number" data-key="f2_zd_column"></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“ ä»Šæ—¥å¤‡æ³¨</div>
                <textarea id="memo" data-key="ybb_memo" placeholder="åœ¨æ­¤è¾“å…¥ç‰¹æ®Šæƒ…å†µã€è¿›åº¦æ»åè¯´æ˜æˆ–æ˜æ—¥è®¡åˆ’..."></textarea>
            </div>
        </div>
        <div id="timestamp-watermark"></div>
    </div>
</div>

<div class="footer-btn">
    <button class="btn-image" onclick="generateImage()">ğŸ“¸ ç”Ÿæˆå¾®ä¿¡æŠ¥è¡¨å›¾ç‰‡</button>
    <button class="btn-export" onclick="submitAndExport()">ğŸ“Š å¯¼å‡ºExcelè¡¨æ ¼æ–‡ä»¶</button>
</div>

<div id="preview-overlay">
    <p style="color:white;margin-bottom:15px;font-weight:bold">å›¾ç‰‡å·²ç”Ÿæˆï¼é•¿æŒ‰ä¸‹æ–¹å›¾ç‰‡ä¿å­˜</p>
    <img id="preview-image" src="" alt="æŠ¥è¡¨é¢„è§ˆ">
    <button onclick="closePreview()" style="margin-top:20px;padding:12px 40px;border-radius:25px;border:none;background:#ff4d4f;color:white;font-size:16px;cursor:pointer">å…³é—­é¢„è§ˆ</button>
</div>

<script>
    const storageKey = "ybb_data_final_v5";
    const baseKey = "ybb_base_final_v5";

    // 1. åˆå§‹åŒ– ST01-06 è¡¨æ ¼
    const stTbody = document.getElementById('st_tbody');
    for(let i=1; i<=6; i++){
        const id = 'st0' + i;
        stTbody.innerHTML += `
            <tr><td class="row-label">ST0${i}</td>
                <td><input type="number" data-key="${id}_sc"></td><td><input type="number" data-key="${id}_re"></td>
                <td><input type="number" data-key="${id}_fo"></td><td><input type="number" data-key="${id}_co"></td></tr>`;
    }

    // 2. é¡µé¢åŠ è½½é€»è¾‘
    window.onload = function() {
        document.getElementById('dateDisplay').innerText = "å¡«æŠ¥æ—¥æœŸï¼š" + new Date().toLocaleDateString();
        const base = JSON.parse(localStorage.getItem(baseKey) || '{}');
        const draft = JSON.parse(localStorage.getItem(storageKey) || '{}');

        document.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => {
            const k = el.dataset.key;
            el.value = draft[k] || ""; 
            
            // åˆå§‹çº¢å­—åˆ¤æ–­
            if(el.tagName === 'INPUT' && el.value !== "" && el.value != (base[k] || "0")){
                el.classList.add('is-changed');
            }

            // å®æ—¶ä¿å­˜å’Œå˜è‰²
            el.oninput = function() {
                const currentDraft = JSON.parse(localStorage.getItem(storageKey) || '{}');
                currentDraft[k] = this.value;
                localStorage.setItem(storageKey, JSON.stringify(currentDraft));

                if(this.tagName === 'INPUT'){
                    if(this.value != (base[k] || "0")) this.classList.add('is-changed');
                    else this.classList.remove('is-changed');
                }
            };
        });
    };

    // 3. ç”Ÿæˆå¾®ä¿¡å›¾ç‰‡åŠŸèƒ½
    async function generateImage() {
        const watermark = document.getElementById('timestamp-watermark');
        const now = new Date();
        watermark.innerText = "å°¹å…µå…µç¡®è®¤äº: " + now.toLocaleString();
        watermark.style.display = "block"; 

        const captureArea = document.getElementById('capture-area');
        
        try {
            const canvas = await html2canvas(captureArea, {
                useCORS: true,
                scale: 2, // 2å€é‡‡æ ·æé«˜æ–‡å­—æ¸…æ™°åº¦
                backgroundColor: "#f0f2f5",
                logging: false
            });
            
            const imgData = canvas.toDataURL("image/png");
            document.getElementById('preview-image').src = imgData;
            document.getElementById('preview-overlay').style.display = "flex";
            watermark.style.display = "none"; 
        } catch (err) {
            alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•");
            console.error(err);
        }
    }

    function closePreview() {
        document.getElementById('preview-overlay').style.display = "none";
    }

    // 4. å¯¼å‡ºExcelåŠŸèƒ½ (åŒæ—¶æ›´æ–°åŸºå‡†)
    function submitAndExport() {
        const currentData = {};
        let excelRows = "";
        const dateStr = new Date().toLocaleDateString();

        document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('.section-title')?.innerText;
            const table = sec.querySelector('table');
            if(table) {
                excelRows += `<tr style="background:#d9e1f2"><td colspan="2"><b>${title}</b></td></tr>`;
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.innerText);
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const rowName = tr.querySelector('.row-label').innerText;
                    excelRows += `<tr style="background:#f2f2f2"><td colspan="2"><b>${rowName}</b></td></tr>`;
                    tr.querySelectorAll('input').forEach((inp, idx) => {
                        const val = inp.value || "0";
                        currentData[inp.dataset.key] = val;
                        const isRed = inp.classList.contains('is-changed');
                        const style = isRed ? 'style="color:red;font-weight:bold"' : '';
                        excelRows += `<tr><td>ã€€${headers[idx+1]}</td><td ${style}>${val}</td></tr>`;
                    });
                });
            }
        });

        const memoVal = document.getElementById('memo').value;
        currentData['ybb_memo'] = memoVal;
        if(memoVal) excelRows += `<tr style="background:#fff2cc"><td><b>ä»Šæ—¥å¤‡æ³¨</b></td><td style="text-align:left">${memoVal}</td></tr>`;

        // æ ¸å¿ƒï¼šç‚¹å‡»å¯¼å‡ºåï¼Œå°†å½“å‰æ•°æ®è®¾ä¸ºæ–°çš„å¯¹æ¯”åŸºå‡†ï¼Œä¸‹æ¬¡è¾“å…¥å˜åŠ¨æ‰ä¼šå˜çº¢
        localStorage.setItem(baseKey, JSON.stringify(currentData));

        const template = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
            <head><meta charset="utf-8"></head>
            <body>
                <table border="1">
                    <tr style="height:40px; background:#4472c4; color:white; font-size:18px">
                        <th colspan="2">å°¹å…µå…µ - åœŸå»ºè¿›åº¦æ—¥æŠ¥ (${dateStr})</th>
                    </tr>
                    ${excelRows}
                </table>
            </body>
            </html>`;

        const blob = new Blob([template], { type: 'application/vnd.ms-excel' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `å°¹å…µå…µ_æ—¥æŠ¥_${dateStr}.xls`;
        link.click();
        
        alert("Excel å·²å¯¼å‡ºï¼Œæ•°æ®å·²å­˜æ¡£ä½œä¸ºæ˜æ—¥æ¯”å¯¹åŸºå‡†ï¼");
    }
</script>
</body>
</html>