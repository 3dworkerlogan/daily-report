<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¼ åº†é€¢ - é¢„åˆ¶æ„ä»¶æ—¥æŠ¥</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:sans-serif;background:#eef7ff;padding:15px}
    .container{max-width:900px;margin:0 auto;background:white;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);padding:20px}
    .header{text-align:center;padding:15px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;border-radius:8px;margin-bottom:20px}
    .section{margin-bottom:25px}
    .section-title{font-size:18px;color:#007bff;font-weight:bold;margin-bottom:10px;border-bottom:2px solid #eee;padding-bottom:5px}
    table{width:100%;border-collapse:collapse;margin-bottom:10px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#f8fbff}
    .row-label{background:#fafafa;font-weight:bold;text-align:left;width:120px}
    input{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center}
    input.is-changed { color: red !important; font-weight: bold; border-color: red; background:#fffafa}
    textarea{width:100%;height:100px;padding:10px;border:1px solid #ccc;border-radius:8px;resize:none}
    .btn-export{width:100%;padding:15px;background:#00a8cc;color:white;border:none;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer}
</style>
</head>
<body>
<div class="container">
    <div class="header"><h1>ğŸ—ï¸ å¼ åº†é€¢ - é¢„åˆ¶æ„ä»¶æŠ¥è¡¨</h1><p id="dateDisplay"></p></div>
    
    <div class="section">
        <div class="section-title">1ï¸âƒ£ é¢„åˆ¶æ„ä»¶å®‰è£…è¿›åº¦ (%)</div>
        <table>
            <thead><tr><th>åŒºåŸŸ</th><th>æ¢ (Beam)</th><th>æ¿ (Slab)</th><th>æŸ± (Column)</th></tr></thead>
            <tbody id="pc_body">
                </tbody>
        </table>
    </div>

    <div class="section">
        <div class="section-title">2ï¸âƒ£ GF åº•æ¿æŸ±è„šæ¸…ç†æƒ…å†µ</div>
        <table>
            <tbody id="clean_body">
                </tbody>
        </table>
    </div>

    <div class="section">
        <div class="section-title">ğŸ“ ä»Šæ—¥å¤‡æ³¨ (å°†å¯¼å‡ºåˆ°æ–‡ä»¶ä¸­)</div>
        <textarea id="memo" data-key="zqf_memo" placeholder="å¡«å†™æ„ä»¶åˆ°åœºã€åŠè£…å¼‚å¸¸æˆ–å…¶ä»–è¯´æ˜..."></textarea>
    </div>

    <button class="btn-export" onclick="submitAndExport()">âœ… æäº¤å¹¶å¯¼å‡ºæŠ¥è¡¨</button>
</div>

<script>
    const prefix = "zqf_v2_";
    const baseKey = prefix + "base";
    const draftKey = prefix + "draft";

    window.onload = function() {
        document.getElementById('dateDisplay').innerText = "æ—¥æœŸï¼š" + new Date().toLocaleDateString();
        
        // åŠ¨æ€ç”Ÿæˆæ„ä»¶å®‰è£…è¡Œ (Zone A-D)
        const zones = ['A', 'B', 'C', 'D'];
        zones.forEach(z => {
            document.getElementById('pc_body').innerHTML += `
                <tr><td class="row-label">Zone ${z}</td>
                <td><input data-key="z${z}_bm"></td><td><input data-key="z${z}_sl"></td><td><input data-key="z${z}_cl"></td></tr>`;
        });

        // åŠ¨æ€ç”Ÿæˆæ¸…ç†è¡Œ (Zone A-E)
        const cleanZones = ['A', 'B', 'C', 'D', 'E'];
        cleanZones.forEach(z => {
            document.getElementById('clean_body').innerHTML += `
                <tr><td class="row-label">Zone ${z} æ¸…ç†</td><td><input data-key="clean_${z}"></td></tr>`;
        });

        const base = JSON.parse(localStorage.getItem(baseKey) || '{}');
        const draft = JSON.parse(localStorage.getItem(draftKey) || '{}');

        document.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => {
            const k = el.dataset.key;
            el.value = draft[k] || "";
            if(el.tagName==='INPUT' && el.value != (base[k]||"")) el.classList.add('is-changed');

            el.oninput = function() {
                const d = JSON.parse(localStorage.getItem(draftKey) || '{}');
                d[k] = this.value;
                localStorage.setItem(draftKey, JSON.stringify(d));
                if(this.tagName==='INPUT') this.classList.toggle('is-changed', this.value != (base[k]||""));
            };
        });
    };

    function submitAndExport() {
        const current = {};
        let rows = "";
        const dateStr = new Date().toLocaleDateString();

        document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('.section-title')?.innerText;
            const table = sec.querySelector('table');
            if(table){
                rows += `<tr style="background:#deeaf6"><td colspan="2"><b>${title}</b></td></tr>`;
                const heads = Array.from(table.querySelectorAll('th')).map(th=>th.innerText);
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const label = tr.querySelector('.row-label').innerText;
                    rows += `<tr style="background:#f8f9fa"><td colspan="2"><b>${label}</b></td></tr>`;
                    tr.querySelectorAll('input').forEach((inp, idx) => {
                        current[inp.dataset.key] = inp.value || "0";
                        const style = inp.classList.contains('is-changed') ? 'style="color:red;font-weight:bold"' : '';
                        const colName = heads.length > 0 ? heads[idx+1] : "è¿›åº¦å€¼";
                        rows += `<tr><td>ã€€${colName}</td><td ${style}>${inp.value || "0"}</td></tr>`;
                    });
                });
            }
        });

        const memoVal = document.getElementById('memo').value;
        current['zqf_memo'] = memoVal;
        if(memoVal) rows += `<tr style="background:#fff2cc"><td><b>ä»Šæ—¥å¤‡æ³¨</b></td><td>${memoVal}</td></tr>`;

        localStorage.setItem(baseKey, JSON.stringify(current));
        const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="utf-8"></head><body><table border="1"><tr><th colspan="2" style="background:#0070c0;color:white">å¼ åº†é€¢é¢„åˆ¶æ„ä»¶æ—¥æŠ¥ (${dateStr})</th></tr>${rows}</table></body></html>`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([template], {type:'application/vnd.ms-excel'}));
        a.download = `å¼ åº†é€¢_æ—¥æŠ¥_${dateStr}.xls`;
        a.click();
        alert("è€å¼ å¹¸è‹¦äº†ï¼è®°å¾—æŠŠå¯¼å‡ºçš„æ–‡ä»¶å‘ç¾¤é‡Œã€‚");
    }
</script>
</body>
</html>