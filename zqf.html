<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¼ åº†é€¢ - é¢„åˆ¶æ„ä»¶æ—¥æŠ¥</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
        background:#eef7ff;
        padding:15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    /* capture-area ç”¨äºåŒ…è£¹æˆªå›¾èŒƒå›´ */
    #capture-area { 
        background:#eef7ff; 
        padding-bottom: 5px;
    }
    .container{
        max-width:900px;
        margin:0 auto;
        background:white;
        border-radius:12px;
        box-shadow:0 4px 15px rgba(0,0,0,0.1);
        padding:20px;
        position:relative
    }
    .header{
        text-align:center;
        padding:15px;
        background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
        color:white;
        border-radius:8px;
        margin-bottom:20px
    }
    .header h1 {
        font-size: 22px;
        line-height: 1.4;
        margin-bottom: 8px;
    }
    .header p {
        font-size: 14px;
        line-height: 1.4;
    }
    .section{margin-bottom:25px}
    .section-title{
        font-size:18px;
        color:#007bff;
        font-weight:bold;
        margin-bottom:10px;
        border-bottom:2px solid #eee;
        padding-bottom:5px;
        line-height: 1.5;
    }
    table{
        width:100%;
        border-collapse:collapse;
        margin-bottom:10px
    }
    th,td{
        border:1px solid #ddd;
        padding:10px;
        text-align:center;
        font-size: 14px;
        line-height: 1.5;
    }
    th{background:#f8fbff}
    .row-label{
        background:#fafafa;
        font-weight:bold;
        text-align:left;
        width:100px;
        font-size: 14px;
    }
    input{
        width:100%;
        padding:8px;
        border:1px solid #ccc;
        border-radius:4px;
        text-align:center;
        outline:none;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }
    input.is-changed { 
        color: red !important; 
        font-weight: bold; 
        border-color: red; 
        background:#fffafa
    }
    textarea{
        width:100%;
        height:100px;
        padding:10px;
        border:1px solid #ccc;
        border-radius:8px;
        resize:none;
        outline:none;
        font-size: 14px;
        line-height: 1.6;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }
    
    .footer-btns{display:flex;flex-direction:column;gap:12px;margin-top:20px}
    .btn-export{
        width:100%;
        padding:15px;
        background:#00a8cc;
        color:white;
        border:none;
        border-radius:30px;
        font-size:18px;
        font-weight:bold;
        cursor:pointer
    }
    .btn-image{
        width:100%;
        padding:15px;
        background:#07c160;
        color:white;
        border:none;
        border-radius:30px;
        font-size:18px;
        font-weight:bold;
        cursor:pointer
    }
    
    /* æ—¶é—´æˆ³æ°´å° */
    #timestamp-watermark { 
        display: none; 
        text-align: right; 
        padding: 10px; 
        color: #999; 
        font-size: 12px; 
        font-style: italic;
        line-height: 1.5;
    }

    /* é¢„è§ˆå±‚ */
    #preview-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.9); 
        z-index: 1000; 
        display: none; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        padding: 20px; 
    }
    #preview-image { 
        max-width: 100%; 
        max-height: 80%; 
        border: 2px solid white; 
        border-radius: 8px; 
    }
    
    /* Loading æç¤º */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="loading-content">
        <p>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</p>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">è¯·ç¨å€™</p>
    </div>
</div>

<div id="capture-area">
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ å¼ åº†é€¢ - é¢„åˆ¶æ„ä»¶æŠ¥è¡¨</h1>
            <p id="dateDisplay"></p>
        </div>
        
        <div class="section">
            <div class="section-title">1. 1F é¢„åˆ¶æ„ä»¶å®‰è£…è¿›åº¦</div>
            <table>
                <thead><tr><th>åŒºåŸŸ</th><th>æ¢</th><th>æ¿</th><th>æŸ±</th></tr></thead>
                <tbody id="pc_body_1f"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">2. 2F é¢„åˆ¶æ„ä»¶å®‰è£…è¿›åº¦</div>
            <table>
                <thead><tr><th>åŒºåŸŸ</th><th>æ¢</th><th>æ¿</th><th>æŸ±</th></tr></thead>
                <tbody id="pc_body_2f"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">3. GF åº•æ¿æŸ±è„šæ¸…ç†æƒ…å†µ</div>
            <table>
                <tbody id="clean_body"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">ğŸ“ ä»Šæ—¥å¤‡æ³¨</div>
            <textarea id="memo" data-key="zqf_memo" placeholder="å¡«å†™æ„ä»¶åˆ°åœºã€åŠè£…å¼‚å¸¸æˆ–å…¶ä»–è¯´æ˜..."></textarea>
        </div>

        <div id="timestamp-watermark"></div>
    </div>
</div>

<div class="footer-btns">
    <button class="btn-image" onclick="generateImage()">ğŸ“¸ ç”Ÿæˆå¾®ä¿¡å›¾ç‰‡æŠ¥è¡¨</button>
    <button class="btn-export" onclick="submitAndExport()">âœ… æäº¤å¹¶å¯¼å‡º Excel</button>
</div>

<div id="preview-overlay">
    <p style="color:white;margin-bottom:15px;font-size:16px">å›¾ç‰‡å·²ç”Ÿæˆï¼é•¿æŒ‰ä¿å­˜å¹¶å‘é€</p>
    <img id="preview-image" src="" alt="æŠ¥è¡¨é¢„è§ˆ">
    <button onclick="closePreview()" style="margin-top:20px;padding:10px 30px;border-radius:20px;border:none;background:#ff4d4f;color:white;font-size:16px">å…³é—­</button>
</div>

<script>
    const prefix = "zqf_v3_";
    const baseKey = prefix + "base";
    const draftKey = prefix + "draft";

    window.onload = function() {
        document.getElementById('dateDisplay').innerText = "å¡«æŠ¥æ—¥æœŸï¼š" + new Date().toLocaleDateString();
        
        const zones = ['A', 'B', 'C', 'D', 'E'];
        
        // ç”Ÿæˆ 1F è¡Œ
        const body1f = document.getElementById('pc_body_1f');
        zones.forEach(z => {
            body1f.innerHTML += `<tr><td class="row-label">Zone ${z}</td>
                <td><input data-key="1f_z${z}_bm"></td><td><input data-key="1f_z${z}_sl"></td><td><input data-key="1f_z${z}_cl"></td></tr>`;
        });

        // ç”Ÿæˆ 2F è¡Œ
        const body2f = document.getElementById('pc_body_2f');
        zones.forEach(z => {
            body2f.innerHTML += `<tr><td class="row-label">Zone ${z}</td>
                <td><input data-key="2f_z${z}_bm"></td><td><input data-key="2f_z${z}_sl"></td><td><input data-key="2f_z${z}_cl"></td></tr>`;
        });

        // ç”Ÿæˆæ¸…ç†è¡Œ
        const cleanBody = document.getElementById('clean_body');
        zones.forEach(z => {
            cleanBody.innerHTML += `<tr><td class="row-label">Zone ${z} æ¸…ç†</td><td><input data-key="clean_${z}"></td></tr>`;
        });

        // åŠ è½½æ•°æ®
        const base = JSON.parse(localStorage.getItem(baseKey) || '{}');
        const draft = JSON.parse(localStorage.getItem(draftKey) || '{}');

        document.querySelectorAll('input[data-key], textarea[data-key]').forEach(el => {
            const k = el.dataset.key;
            el.value = draft[k] || "";
            if(el.tagName==='INPUT' && el.value != (base[k]||"")) el.classList.add('is-changed');

            el.oninput = function() {
                const d = JSON.parse(localStorage.getItem(draftKey) || '{}');
                d[k] = this.value;
                localStorage.setItem(draftKey, JSON.stringify(d));
                if(this.tagName==='INPUT') this.classList.toggle('is-changed', this.value != (base[k]||""));
            };
        });
    };

    function closePreview() {
        document.getElementById('preview-overlay').style.display = 'none';
    }

    // å›¾ç‰‡ç”Ÿæˆ - ä¼˜åŒ–ç‰ˆ
    async function generateImage() {
        const loading = document.getElementById('loading');
        const watermark = document.getElementById('timestamp-watermark');
        const captureArea = document.getElementById('capture-area');
        
        try {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            loading.style.display = 'flex';
            
            // è®¾ç½®æ°´å°
            watermark.innerText = "å¼ åº†é€¢ç¡®è®¤äº: " + new Date().toLocaleString();
            watermark.style.display = "block";
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ¸²æŸ“å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // è‡ªåŠ¨æ£€æµ‹è®¾å¤‡åƒç´ æ¯”
            const devicePixelRatio = window.devicePixelRatio || 1;
            const scale = Math.min(devicePixelRatio, 2); // æœ€å¤§2å€ï¼Œé¿å…è¿‡å¤§
            
            const canvas = await html2canvas(captureArea, {
                scale: scale,
                useCORS: true,
                allowTaint: false,
                backgroundColor: "#eef7ff",
                logging: false,
                windowWidth: captureArea.scrollWidth,
                windowHeight: captureArea.scrollHeight,
                // å­—ä½“æ¸²æŸ“ä¼˜åŒ–
                letterRendering: true,
                imageTimeout: 0,
                onclone: function(clonedDoc) {
                    // ç¡®ä¿å…‹éš†æ–‡æ¡£ä¸­çš„å­—ä½“æ ·å¼æ­£ç¡®
                    const clonedArea = clonedDoc.getElementById('capture-area');
                    if (clonedArea) {
                        clonedArea.style.fontFamily = '-apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", Arial, sans-serif';
                    }
                }
            });
            
            watermark.style.display = "none";
            loading.style.display = 'none';
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const imgData = canvas.toDataURL("image/png", 1.0);
            document.getElementById('preview-image').src = imgData;
            document.getElementById('preview-overlay').style.display = "flex";
            
        } catch (error) {
            console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
            watermark.style.display = "none";
            loading.style.display = 'none';
            alert('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯ä¿¡æ¯ï¼š' + error.message);
        }
    }

    // Excel å¯¼å‡º
    function submitAndExport() {
        const current = {};
        let rows = "";
        const dateStr = new Date().toLocaleDateString();

        document.querySelectorAll('.section').forEach(sec => {
            const title = sec.querySelector('.section-title')?.innerText;
            const table = sec.querySelector('table');
            if(table){
                rows += `<tr style="background:#deeaf6"><td colspan="2"><b>${title}</b></td></tr>`;
                const heads = Array.from(table.querySelectorAll('th')).map(th=>th.innerText);
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const label = tr.querySelector('.row-label').innerText;
                    rows += `<tr style="background:#f8f9fa"><td colspan="2"><b>${label}</b></td></tr>`;
                    tr.querySelectorAll('input').forEach((inp, idx) => {
                        current[inp.dataset.key] = inp.value || "0";
                        const style = inp.classList.contains('is-changed') ? 'style="color:red;font-weight:bold"' : '';
                        const colName = heads.length > 0 ? heads[idx+1] : "å®Œæˆæ•°";
                        rows += `<tr><td>ã€€${colName}</td><td ${style}>${inp.value || "0"}</td></tr>`;
                    });
                });
            }
        });

        const memoVal = document.getElementById('memo').value;
        current['zqf_memo'] = memoVal;
        if(memoVal) rows += `<tr style="background:#fff2cc"><td><b>ä»Šæ—¥å¤‡æ³¨</b></td><td>${memoVal}</td></tr>`;

        localStorage.setItem(baseKey, JSON.stringify(current));
        const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="utf-8"></head><body><table border="1"><tr><th colspan="2" style="background:#0070c0;color:white">å¼ åº†é€¢é¢„åˆ¶æ„ä»¶æ—¥æŠ¥ (${dateStr})</th></tr>${rows}</table></body></html>`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([template], {type:'application/vnd.ms-excel'}));
        a.download = `å¼ åº†é€¢_æ—¥æŠ¥_${dateStr.replace(/\//g, '-')}.xls`;
        a.click();
        alert("è€å¼ è¾›è‹¦äº†ï¼æ•°æ®å·²åŒæ­¥ä¸ºåŸºå‡†ï¼ŒExcelå·²å¯¼å‡ºã€‚");
    }
</script>
</body>
</html>
